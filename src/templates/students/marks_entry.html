<!-- templates/students/marks_entry.html -->
{% extends "base.html" %}
{% block content %}
{% load custom_tags %}
<h2>Enter Marks – {{ exam_course_subject.exam.name }} / {{ exam_course_subject.course_subject.subject.name }}</h2>

<form method="post">
  {% csrf_token %}
  {{ formset.management_form }}
  <table border="1" cellpadding="5">
    <thead>
      <tr>
        <th>Student</th>
        <th>Marks (A = Absent)</th>
      </tr>
    </thead>
    <tbody>
      {% for form, student in formset.forms|zip_lists:students %}
  <tr>
    <td>{{ student.student.user.get_full_name }}</td>
    <td>
      {{ form.score }}
      {{ form.student_admission }}
      {{ form.exam_course_subject }}
      {{ form.id }}
    </td>
  </tr>
{% endfor %}

    </tbody>
  </table>
  <button type="submit">Save Marks</button>
</form>

<a href="{% url 'subject_list' exam_course_subject.exam.session.id exam_course_subject.exam.id course_id %}">
  ← Back to Subjects
</a>

<!-- Add this HTML and JavaScript at the bottom of your template, before the closing </body> tag -->
<!-- Bulk Score Entry Section -->
<div id="bulk-score-entry" class="my-5 p-4 border-2 border-blue-600 rounded bg-gray-100">
    <h3 class="mt-0 text-gray-800 text-lg font-semibold">Bulk Score Entry</h3>
    <p class="text-gray-600 text-sm">
        Enter scores separated by commas. Use consecutive commas (,,) for missing scores.<br>
        Example: 85.5, 92, , 78.25, , 88
    </p>
    <textarea 
        id="bulk-scores-input" 
        placeholder="Enter scores separated by commas (e.g., 85.5, 92, , 78.25)"
        class="w-full min-h-[80px] p-2 border border-gray-300 rounded font-mono text-sm"
    ></textarea>
    <div class="mt-3 flex items-center">
        <span id="score-count" class="text-gray-600 text-sm"></span>
        <button 
            type="button" 
            id="apply-bulk-scores" 
            class="ml-4 px-5 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 focus:outline-none"
        >
            Apply Scores
        </button>
        <button 
            type="button" 
            id="clear-bulk-scores" 
            class="ml-3 px-5 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700 focus:outline-none"
        >
            Clear
        </button>
    </div>
    <div id="bulk-score-message" class="mt-3 p-2 rounded hidden"></div>
</div>


<script>
(function() {
    // Get all score input fields
    const scoreInputs = document.querySelectorAll('input[type="number"][name*="score"]');
    const totalFields = scoreInputs.length;
    
    // Get bulk entry elements
    const bulkInput = document.getElementById('bulk-scores-input');
    const applyButton = document.getElementById('apply-bulk-scores');
    const clearButton = document.getElementById('clear-bulk-scores');
    const scoreCount = document.getElementById('score-count');
    const messageDiv = document.getElementById('bulk-score-message');
    
    // Update count display
    function updateCount() {
        scoreCount.textContent = `Form has ${totalFields} score field${totalFields !== 1 ? 's' : ''}`;
    }
    
    // Show message
    function showMessage(text, type) {
        messageDiv.textContent = text;
        messageDiv.style.display = 'block';
        
        if (type === 'success') {
            messageDiv.style.backgroundColor = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.style.border = '1px solid #c3e6cb';
        } else if (type === 'error') {
            messageDiv.style.backgroundColor = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.style.border = '1px solid #f5c6cb';
        } else {
            messageDiv.style.backgroundColor = '#fff3cd';
            messageDiv.style.color = '#856404';
            messageDiv.style.border = '1px solid #ffeaa7';
        }
        
        // Auto-hide success messages after 3 seconds
        if (type === 'success') {
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
    }
    
    // Parse and validate scores
    function parseScores(input) {
        // Split by comma and process each value
        const parts = input.split(',');
        const scores = [];
        
        for (let part of parts) {
            // Trim whitespace
            const trimmed = part.trim();
            
            if (trimmed === '') {
                // Empty value (consecutive commas or spaces between commas)
                scores.push(null);
            } else {
                // Try to parse as number
                const num = parseFloat(trimmed);
                if (isNaN(num)) {
                    throw new Error(`Invalid score value: "${trimmed}"`);
                }
                scores.push(num);
            }
        }
        
        return scores;
    }
    
    // Apply scores to form
    function applyScores() {
        try {
            const inputValue = bulkInput.value.trim();
            
            if (!inputValue) {
                showMessage('Please enter scores separated by commas', 'error');
                return;
            }
            
            const scores = parseScores(inputValue);
            
            // Check if number of scores matches number of fields
            if (scores.length !== totalFields) {
                showMessage(
                    `Error: You provided ${scores.length} score${scores.length !== 1 ? 's' : ''}, but the form has ${totalFields} field${totalFields !== 1 ? 's' : ''}. Please check your input.`,
                    'error'
                );
                return;
            }
            
            // Apply scores to fields
            scores.forEach((score, index) => {
                if (score !== null) {
                    scoreInputs[index].value = score.toFixed(2);
                    // Trigger change event for any listeners
                    scoreInputs[index].dispatchEvent(new Event('change', { bubbles: true }));
                    scoreInputs[index].dispatchEvent(new Event('input', { bubbles: true }));
                } else {
                    // Clear the field for missing scores
                    scoreInputs[index].value = '';
                }
            });
            
            showMessage('Scores applied successfully!', 'success');
            
        } catch (error) {
            showMessage(error.message, 'error');
        }
    }
    
    // Clear all fields
    function clearFields() {
        bulkInput.value = '';
        messageDiv.style.display = 'none';
        // Optionally clear the form fields as well
        if (confirm('Do you also want to clear all score fields in the form?')) {
            scoreInputs.forEach(input => {
                input.value = '';
                input.dispatchEvent(new Event('change', { bubbles: true }));
                input.dispatchEvent(new Event('input', { bubbles: true }));
            });
        }
    }
    
    // Real-time validation and preview
    function validateInput() {
        try {
            const inputValue = bulkInput.value.trim();
            if (!inputValue) {
                messageDiv.style.display = 'none';
                return;
            }
            
            const scores = parseScores(inputValue);
            
            if (scores.length === totalFields) {
                showMessage(`✓ Ready to apply ${scores.length} score${scores.length !== 1 ? 's' : ''}`, 'success');
            } else if (scores.length < totalFields) {
                showMessage(`You have ${scores.length} score${scores.length !== 1 ? 's' : ''}, need ${totalFields - scores.length} more`, 'warning');
            } else {
                showMessage(`Too many scores: ${scores.length} provided, only ${totalFields} needed`, 'warning');
            }
        } catch (error) {
            // Don't show error during typing, only on apply
            messageDiv.style.display = 'none';
        }
    }
    
    // Event listeners
    applyButton.addEventListener('click', applyScores);
    clearButton.addEventListener('click', clearFields);
    
    // Real-time validation with debouncing
    let validationTimeout;
    bulkInput.addEventListener('input', () => {
        clearTimeout(validationTimeout);
        validationTimeout = setTimeout(validateInput, 500);
    });
    
    // Enter key to apply scores
    bulkInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            applyScores();
        }
    });
    
    // Initialize
    updateCount();
    
})();
</script>
{% endblock content %}
